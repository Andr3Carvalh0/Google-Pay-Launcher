name: Android Worker

on:
  push:
    tags: '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: prepare keystore
        env:
            ENCODED_STRING: ${{ secrets.GOOGLE_PAY_LAUNCHER_KEYSTORE }}
        run: |
            mkdir ./secrets/
            echo $ENCODED_STRING | base64 -di > ./secrets/release.jks
          
      - name: prepare gradle
        run: chmod +x ./gradlew
        
      - name: build
        run: ./gradlew assembleRelease
        env: 
          GOOGLE_PAY_LAUNCHER_KEY: ${{ secrets.GOOGLE_PAY_LAUNCHER_KEY }}
          GOOGLE_PAY_LAUNCHER_PASSWORD: ${{ secrets.GOOGLE_PAY_LAUNCHER_PASSWORD }}
      
      - name: upload build
        uses: actions/upload-artifact@v2
        with:
          name: artifacts
          path: app/build/outputs/apk/release/

  release:
      name: release APK
      needs: build
      runs-on: ubuntu-latest
      steps:
        - name: Download APK from build
          uses: actions/download-artifact@v2
          with:
            name: artifacts 
        - name: Create Release
          id: create_release
          uses: actions/create-release@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          with:
            tag_name: ${{ github.ref }}
            release_name: Release ${{ github.ref }} 
        - name: Upload Release APK
          id: upload_release_asset
          uses: actions/upload-release-asset@v1.0.1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./app-release.apk
            asset_name: GooglePayLauncher.apk
            asset_content_type: application/zip